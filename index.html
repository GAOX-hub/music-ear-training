<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视唱练听训练系统</title>
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- VexFlow -->
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.3/build/vexflow-min.js"></script>

    <!-- Howler -->
    <script src="https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"></script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>

<body class="bg-gradient-to-br from-indigo-50 to-purple-50 min-h-screen flex flex-col items-center p-4 md:p-8">

<header class="w-full max-w-4xl text-center mb-8">
    <h1 class="text-4xl font-bold text-indigo-700">视唱练听训练系统</h1>
    <p class="text-gray-600 mt-2">从题库选择练习 → 听音频 → 在五线谱输入 → 自动评分</p>
</header>

<main class="w-full max-w-4xl bg-white rounded-2xl shadow-lg p-6 md:p-8 flex flex-col gap-8">

    <!-- =======================
         1. 题目选择 + 音频播放
         ======================= -->
    <section class="border-b border-gray-200 pb-6">
        <h2 class="text-2xl font-semibold text-indigo-600 mb-4 flex items-center gap-2">
            <i class="fas fa-list"></i> 选择练习
        </h2>

        <div class="flex flex-col md:flex-row gap-4 items-center">

            <!-- 题目选择 -->
            <div class="w-full md:w-1/2">
                <label class="block mb-2 text-gray-700">选择一条练习</label>
                <select id="exercise-select" class="w-full p-2 border rounded-lg">
                </select>
            </div>

            <!-- 播放控制 -->
            <div class="flex gap-4 items-center">
                <button id="play-btn" 
                    class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-colors disabled:bg-gray-400">
                    <i class="fas fa-play"></i> 播放题目
                </button>
                <button id="pause-btn" disabled
                    class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors disabled:bg-gray-400">
                    <i class="fas fa-pause"></i> 暂停
                </button>
            </div>

        </div>

        <progress id="audio-progress" value="0" max="100" class="w-full h-3 mt-4"></progress>
    </section>


    <!-- =======================
         2. 五线谱 + 音符输入
         ======================= -->
    <section class="flex flex-col gap-6">

        <h2 class="text-2xl font-semibold text-indigo-600 flex items-center gap-2">
            <i class="fas fa-pencil-alt"></i> 输入音符
        </h2>

        <!-- 五线谱 -->
        <div id="staff-container" class="w-full h-64 bg-gray-50 border rounded-lg flex items-center justify-center"></div>

        <!-- 音符按钮 -->
        <div class="flex flex-wrap gap-2 justify-center">
            <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg" data-note="C4">Do (C4)</button>
            <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg" data-note="D4">Re (D4)</button>
            <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg" data-note="E4">Mi (E4)</button>
            <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg" data-note="F4">Fa (F4)</button>
            <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg" data-note="G4">Sol (G4)</button>
            <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg" data-note="A4">La (A4)</button>
            <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg" data-note="B4">Si (B4)</button>
            <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg" data-note="C5">Do (C5)</button>
        </div>

        <!-- 操作按钮 -->
        <div class="flex justify-center gap-4">
            <button id="clear-btn" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600">
                <i class="fas fa-trash"></i> 清空
            </button>
            <button id="submit-btn" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600">
                <i class="fas fa-check"></i> 提交答案
            </button>
        </div>

    </section>


    <!-- =======================
         3. 评分与答案展示
         ======================= -->
    <section class="border-t border-gray-200 pt-6 text-center">

        <h2 class="text-2xl font-semibold text-indigo-600 flex items-center justify-center gap-2 mb-4">
            <i class="fas fa-graduation-cap"></i> 评分结果
        </h2>

        <div id="score-display" class="text-3xl font-bold text-gray-700">
            得分：--/100
        </div>

        <div id="correct-answer" class="text-xl text-gray-600 mt-4 hidden">
            正确答案：<span id="answer-text"></span>
        </div>

        <button id="reset-btn" class="mt-6 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700">
            <i class="fas fa-refresh"></i> 重新开始
        </button>

    </section>

</main>

<footer class="mt-8 text-gray-500">
    © 2025 视唱练听训练系统
</footer>



<!-- =======================
     JavaScript 部分
     ======================= -->
<script>
/* ------------------------------
   题库（你只需要编辑这里）
--------------------------------*/
const EXERCISES = [
    {
        title: "练习 1：C大调上行",
        audio: "audio/q1.mp3",
        answer: ["C4","D4","E4","F4","G4"]
    },
    {
        title: "练习 2：C大调下行",
        audio: "audio/q2.mp3",
        answer: ["G4","F4","E4","D4","C4"]
    }
];



/* ------------------------------
   全局变量
--------------------------------*/
let renderer, staff;
let inputNotes = [];
let correctNotes = [];
let player = null;



/* ------------------------------
   五线谱初始化
--------------------------------*/
function initStaff() {
    const container = document.getElementById("staff-container");
    container.innerHTML = "";

    renderer = new Vex.Flow.Renderer(container, Vex.Flow.Renderer.Backends.SVG);
    renderer.resize(container.clientWidth - 20, container.clientHeight - 20);

    const context = renderer.getContext();

    staff = new Vex.Flow.Stave(10, 10, container.clientWidth - 40);
    staff.addClef("treble");
    staff.setContext(context).draw();
}



/* ------------------------------
   渲染用户输入的音符
--------------------------------*/
function renderNotes() {
    initStaff();
    
    const context = renderer.getContext();

    if (inputNotes.length === 0) return;

    const notes = inputNotes.map(n => {
        const m = n.match(/^([A-G])(#|b)?(\d)$/);
        const key = `${m[1].toLowerCase()}${m[2] || ""}/${m[3]}`;
        const note = new Vex.Flow.StaveNote({ keys: [key], duration: "q" });

        if (m[2]) note.addModifier(new Vex.Flow.Accidental(m[2]), 0);

        return note;
    });

    const voice = new Vex.Flow.Voice({ num_beats: notes.length, beat_value: 4 });
    voice.addTickables(notes);

    new Vex.Flow.Formatter().joinVoices([voice]).format([voice], staff.getWidth() - 50);
    voice.draw(context, staff);
}



/* ------------------------------
   题库下拉框初始化
--------------------------------*/
const exerciseSelect = document.getElementById("exercise-select");

EXERCISES.forEach((ex, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.innerText = ex.title;
    exerciseSelect.appendChild(opt);
});



/* ------------------------------
   切换题目
--------------------------------*/
function loadExercise(index) {
    const ex = EXERCISES[index];
    correctNotes = ex.answer;
    inputNotes = [];
    renderNotes();

    // 载入音频
    player = new Howl({
        src: [ex.audio],
        html5: true,
        onplay: () => {
            playBtn.disabled = true;
            pauseBtn.disabled = false;
            updateProgress();
        },
        onend: () => {
            playBtn.disabled = false;
            pauseBtn.disabled = true;
        }
    });
}

exerciseSelect.addEventListener("change", e => {
    loadExercise(e.target.value);
});



/* ------------------------------
   音频播放按钮
--------------------------------*/
const playBtn = document.getElementById("play-btn");
const pauseBtn = document.getElementById("pause-btn");
const progressBar = document.getElementById("audio-progress");

function updateProgress() {
    if (player && player.playing()) {
        progressBar.value = (player.seek() / player.duration()) * 100;
        requestAnimationFrame(updateProgress);
    }
}

playBtn.addEventListener("click", () => player.play());
pauseBtn.addEventListener("click", () => player.pause());



/* ------------------------------
   音符输入按钮
--------------------------------*/
document.querySelectorAll(".note-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        inputNotes.push(btn.dataset.note);
        renderNotes();
    });
});

document.getElementById("clear-btn").addEventListener("click", () => {
    inputNotes = [];
    renderNotes();
});



/* ------------------------------
   提交答案
--------------------------------*/
document.getElementById("submit-btn").addEventListener("click", () => {

    if (inputNotes.length === 0) {
        alert("请先输入音符！");
        return;
    }

    let score = 0;
    const len = Math.min(inputNotes.length, correctNotes.length);

    for (let i = 0; i < len; i++) {
        if (inputNotes[i] === correctNotes[i]) score += 20;
    }

    document.getElementById("score-display").innerText = `得分：${score}/100`;

    document.getElementById("answer-text").innerText = correctNotes.join("  ");
    document.getElementById("correct-answer").classList.remove("hidden");
});



/* ------------------------------
   重置
--------------------------------*/
document.getElementById("reset-btn").addEventListener("click", () => {
    inputNotes = [];
    renderNotes();
    document.getElementById("score-display").innerText = "得分：--/100";
    document.getElementById("correct-answer").classList.add("hidden");
});

window.onload = () => {
    initStaff();
    loadExercise(0);
};

</script>

</body>
</html>
